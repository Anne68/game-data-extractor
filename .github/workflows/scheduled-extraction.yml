name: ‚è∞ Extraction S√©quentielle Automatis√©e (50 jeux par run)
on:
  schedule:
    # Extraction de 50 jeux toutes les 3 heures
    - cron: '0 */3 * * *'   # 00:00, 03:00, 06:00, 09:00, 12:00, 15:00, 18:00, 21:00
    # Ou plus conservateur: 2 fois par jour
    # - cron: '0 8 * * *'   # 10:00 Paris
    # - cron: '0 20 * * *'  # 22:00 Paris
  workflow_dispatch:
    inputs:
      extraction_count:
        description: "Nombre d'extractions √† faire"
        required: false
        default: '1'
        type: string
      dry_run:
        description: "Mode test (sans insertion en base)"
        required: false
        default: false
        type: boolean

jobs:
  sequential_extraction:
    runs-on: ubuntu-latest
    
    steps:
    - name: üöÄ Extraction S√©quentielle sur AlwaysData
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.AD_HOST }}
        username: ${{ secrets.AD_USER }}
        key: ${{ secrets.AD_SSH_KEY }}
        script: |
          echo "üîç V√©rifications pr√©alables..."
          
          # V√©rifier que le projet existe
          if [ ! -d ~/game-extraction ]; then
            echo "‚ùå R√©pertoire ~/game-extraction introuvable!"
            exit 1
          fi
          
          cd ~/game-extraction
          
          # V√©rifier que le script existe
          if [ ! -f scripts/run_pipeline.py ]; then
            echo "‚ùå Script scripts/run_pipeline.py introuvable!"
            exit 1
          fi
          
          # Variables d'environnement
          export DB_HOST="${{ secrets.DB_HOST }}"
          export DB_USER="${{ secrets.DB_USER }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          export RAWG_API_KEY="${{ secrets.RAWG_API_KEY }}"
          export DISCORD_WEBHOOK="${{ secrets.DISCORD_WEBHOOK }}"
          export NOTIFICATION_EMAIL="${{ secrets.NOTIFICATION_EMAIL }}"
          export LOG_LEVEL="INFO"
          export HEADLESS_MODE="true"
          
          # D√©terminer le nombre d'extractions
          EXTRACTION_COUNT="${{ github.event.inputs.extraction_count }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          
          # Par d√©faut: 1 extraction
          if [ -z "$EXTRACTION_COUNT" ]; then
            EXTRACTION_COUNT=1
          fi
          
          echo "üìä Extraction Count: $EXTRACTION_COUNT"
          echo "üìä Dry Run: $DRY_RUN"
          
          # Afficher le statut initial
          echo "üìã √âtat avant extraction:"
          python3 -c "
          import mysql.connector
          conn = mysql.connector.connect(
              host='${{ secrets.DB_HOST }}',
              user='${{ secrets.DB_USER }}', 
              password='${{ secrets.DB_PASSWORD }}',
              database='${{ secrets.DB_NAME }}'
          )
          cursor = conn.cursor()
          
          # Stats g√©n√©rales
          cursor.execute('SELECT COUNT(*) FROM games')
          total_games = cursor.fetchone()[0]
          
          # √âtat extraction
          cursor.execute('SELECT last_page, total_games_extracted FROM api_state WHERE id = 1')
          result = cursor.fetchone()
          if result:
              last_page, total_extracted = result
              print(f'üéÆ Jeux en base: {total_games}')
              print(f'üìÑ Derni√®re page: {last_page}')  
              print(f'üìä Total extrait: {total_extracted}')
              print(f'üéØ Prochaine page: {last_page + 1}')
          else:
              print(f'üéÆ Jeux en base: {total_games}')
              print(f'üìä Premi√®re extraction')
          
          conn.close()
          "
          
          echo ""
          
          # Boucle d'extraction
          for i in $(seq 1 $EXTRACTION_COUNT); do
            echo "üöÄ Extraction $i/$EXTRACTION_COUNT..."
            
            if [ "$DRY_RUN" = "true" ]; then
              echo "üß™ Mode test activ√©"
              # En mode test, on peut juste afficher ce qui serait fait
              python3 -c "
              print('üß™ MODE TEST - Extraction de 50 jeux')
              print('üìÑ Page qui serait trait√©e: prochaine page')
              print('üéÆ 50 jeux seraient extraits et ins√©r√©s')
              "
            else
              # Extraction r√©elle
              python3 scripts/run_pipeline.py
            fi
            
            # Petite pause entre les extractions (si plusieurs)
            if [ $i -lt $EXTRACTION_COUNT ]; then
              echo "‚è∏Ô∏è Pause de 30 secondes..."
              sleep 30
            fi
          done
          
          echo ""
          echo "üìä √âtat final:"
          python3 -c "
          import mysql.connector
          conn = mysql.connector.connect(
              host='${{ secrets.DB_HOST }}',
              user='${{ secrets.DB_USER }}', 
              password='${{ secrets.DB_PASSWORD }}',
              database='${{ secrets.DB_NAME }}'
          )
          cursor = conn.cursor()
          
          # Stats finales
          cursor.execute('SELECT COUNT(*) FROM games')
          total_games = cursor.fetchone()[0]
          
          cursor.execute('SELECT last_page, total_games_extracted, last_extraction FROM api_state WHERE id = 1')
          result = cursor.fetchone()
          if result:
              last_page, total_extracted, last_extraction = result
              print(f'üéÆ Jeux en base: {total_games}')
              print(f'üìÑ Derni√®re page trait√©e: {last_page}')
              print(f'üìä Total extrait: {total_extracted}')
              print(f'‚è∞ Derni√®re extraction: {last_extraction}')
              
              # Estimer les IDs trait√©s
              min_id = (last_page - 1) * 40
              max_id = last_page * 40
              print(f'üÜî IDs approximatifs: {min_id}-{max_id}')
          
          conn.close()
          "
          
          echo "‚úÖ Extraction s√©quentielle automatis√©e termin√©e!"

    # Notification Discord de succ√®s
    - name: üì¢ Notification Discord - Succ√®s
      if: success()
      run: |
        CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
        EXTRACTION_COUNT="${{ github.event.inputs.extraction_count }}"
        if [ -z "$EXTRACTION_COUNT" ]; then
          EXTRACTION_COUNT=1
        fi
        
        curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
        -H "Content-Type: application/json" \
        -d '{
          "embeds": [{
            "title": "‚úÖ Extraction Automatique R√©ussie",
            "description": "**Extraction s√©quentielle termin√©e avec succ√®s**\n\nüìä **D√©tails:**\n‚Ä¢ Extractions effectu√©es: '$EXTRACTION_COUNT'\n‚Ä¢ Nouveaux jeux: ~'$(($EXTRACTION_COUNT * 50))'\n‚Ä¢ Mode: S√©quentiel automatis√©\n‚Ä¢ Serveur: AlwaysData",
            "color": 3066993,
            "timestamp": "'$CURRENT_TIME'",
            "footer": {"text": "GitHub Actions ‚Ä¢ Game Data Extractor"},
            "fields": [
              {
                "name": "üéØ Statut",
                "value": "Extraction r√©ussie",
                "inline": true
              },
              {
                "name": "üïí Heure",
                "value": "'"$(date '+%H:%M %Z')"'",
                "inline": true
              }
            ]
          }]
        }'

    # Notification Discord d'√©chec
    - name: üì¢ Notification Discord - √âchec
      if: failure()
      run: |
        CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
        
        curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
        -H "Content-Type: application/json" \
        -d '{
          "embeds": [{
            "title": "‚ùå Extraction Automatique √âchou√©e",
            "description": "**Erreur lors de l'\''extraction s√©quentielle**\n\n‚ö†Ô∏è **Action requise:**\nV√©rifiez les logs dans GitHub Actions\n\nüîó **Lien:** [Voir les d√©tails](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})",
            "color": 15158332,
            "timestamp": "'$CURRENT_TIME'",
            "footer": {"text": "GitHub Actions ‚Ä¢ Game Data Extractor"},
            "fields": [
              {
                "name": "üéØ Statut",
                "value": "√âchec d'\''extraction",
                "inline": true
              },
              {
                "name": "üïí Heure",
                "value": "'"$(date '+%H:%M %Z')"'",
                "inline": true
              }
            ]
          }]
        }'

    # Log d√©taill√© en cas d'√©chec
    - name: üìã Logs d'erreur
      if: failure()
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.AD_HOST }}
        username: ${{ secrets.AD_USER }}
        key: ${{ secrets.AD_SSH_KEY }}
        script: |
          echo "üìã Diagnostic en cas d'√©chec..."
          cd ~/game-extraction
          
          # √âtat de la base de donn√©es
          python3 -c "
          try:
              import mysql.connector
              conn = mysql.connector.connect(
                  host='${{ secrets.DB_HOST }}',
                  user='${{ secrets.DB_USER }}', 
                  password='${{ secrets.DB_PASSWORD }}',
                  database='${{ secrets.DB_NAME }}'
              )
              print('‚úÖ Connexion MySQL OK')
              conn.close()
          except Exception as e:
              print(f'‚ùå Erreur MySQL: {e}')
          " || echo "‚ùå Impossible de se connecter √† MySQL"
          
          # V√©rification des fichiers
          echo "üìÇ Fichiers pr√©sents:"
          ls -la scripts/ | grep -E "(run_pipeline|extraction)"
          
          # Logs r√©cents
          if [ -f logs/extraction.log ]; then
            echo "üìÑ Derni√®res lignes du log:"
            tail -20 logs/extraction.log
          else
            echo "üìÑ Aucun log trouv√©"
          fi
