name: â° Extraction SÃ©quentielle AutomatisÃ©e (50 jeux par run)
on:
  schedule:
    # Extraction de 50 jeux toutes les 3 heures
    - cron: '0 */3 * * *'   # 00:00, 03:00, 06:00, 09:00, 12:00, 15:00, 18:00, 21:00
    # Ou plus conservateur: 2 fois par jour
    # - cron: '0 8 * * *'   # 10:00 Paris
    # - cron: '0 20 * * *'  # 22:00 Paris
  workflow_dispatch:
    inputs:
      extraction_count:
        description: "Nombre d'extractions Ã  faire"
        required: false
        default: '1'
        type: string
      dry_run:
        description: "Mode test (sans insertion en base)"
        required: false
        default: false
        type: boolean

jobs:
  sequential_extraction:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸš€ Extraction SÃ©quentielle sur AlwaysData
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.AD_HOST }}
        username: ${{ secrets.AD_USER }}
        key: ${{ secrets.AD_SSH_KEY }}
        script: |
          echo "ðŸ” VÃ©rifications prÃ©alables..."
          
          # VÃ©rifier que le projet existe
          if [ ! -d ~/game-extraction ]; then
            echo "âŒ RÃ©pertoire ~/game-extraction introuvable!"
            exit 1
          fi
          
          cd ~/game-extraction
          
          # VÃ©rifier que le script existe
          if [ ! -f scripts/run_pipeline.py ]; then
            echo "âŒ Script scripts/run_pipeline.py introuvable!"
            exit 1
          fi
          
          # Variables d'environnement
          export DB_HOST="${{ secrets.DB_HOST }}"
          export DB_USER="${{ secrets.DB_USER }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          export RAWG_API_KEY="${{ secrets.RAWG_API_KEY }}"
          export DISCORD_WEBHOOK="${{ secrets.DISCORD_WEBHOOK }}"
          export NOTIFICATION_EMAIL="${{ secrets.NOTIFICATION_EMAIL }}"
          export LOG_LEVEL="INFO"
          export HEADLESS_MODE="true"
          
          # DÃ©terminer le nombre d'extractions
          EXTRACTION_COUNT="${{ github.event.inputs.extraction_count }}"
          DRY_RUN="${{ github.event.inputs.dry_run }}"
          
          # Par dÃ©faut: 1 extraction
          if [ -z "$EXTRACTION_COUNT" ]; then
            EXTRACTION_COUNT=1
          fi
          
          echo "ðŸ“Š Extraction Count: $EXTRACTION_COUNT"
          echo "ðŸ“Š Dry Run: $DRY_RUN"
          
          # Afficher le statut initial
          echo "ðŸ“‹ Ã‰tat avant extraction:"
          python3 -c "
          import mysql.connector
          conn = mysql.connector.connect(
              host='${{ secrets.DB_HOST }}',
              user='${{ secrets.DB_USER }}', 
              password='${{ secrets.DB_PASSWORD }}',
              database='${{ secrets.DB_NAME }}'
          )
          cursor = conn.cursor()
          
          # Stats gÃ©nÃ©rales
          cursor.execute('SELECT COUNT(*) FROM games')
          total_games = cursor.fetchone()[0]
          
          # Ã‰tat extraction
          cursor.execute('SELECT last_page, total_games_extracted FROM api_state WHERE id = 1')
          result = cursor.fetchone()
          if result:
              last_page, total_extracted = result
              print(f'ðŸŽ® Jeux en base: {total_games}')
              print(f'ðŸ“„ DerniÃ¨re page: {last_page}')  
              print(f'ðŸ“Š Total extrait: {total_extracted}')
              print(f'ðŸŽ¯ Prochaine page: {last_page + 1}')
          else:
              print(f'ðŸŽ® Jeux en base: {total_games}')
              print(f'ðŸ“Š PremiÃ¨re extraction')
          
          conn.close()
          "
          
          echo ""
          
          # Boucle d'extraction
          for i in $(seq 1 $EXTRACTION_COUNT); do
            echo "ðŸš€ Extraction $i/$EXTRACTION_COUNT..."
            
            if [ "$DRY_RUN" = "true" ]; then
              echo "ðŸ§ª Mode test activÃ©"
              # En mode test, on peut juste afficher ce qui serait fait
              python3 -c "
              print('ðŸ§ª MODE TEST - Extraction de 50 jeux')
              print('ðŸ“„ Page qui serait traitÃ©e: prochaine page')
              print('ðŸŽ® 50 jeux seraient extraits et insÃ©rÃ©s')
              "
            else
              # Extraction rÃ©elle
              python3 scripts/run_pipeline.py
            fi
            
            # Petite pause entre les extractions (si plusieurs)
            if [ $i -lt $EXTRACTION_COUNT ]; then
              echo "â¸ï¸ Pause de 30 secondes..."
              sleep 30
            fi
          done
          
          echo ""
          echo "ðŸ“Š Ã‰tat final:"
          python3 -c "
          import mysql.connector
          conn = mysql.connector.connect(
              host='${{ secrets.DB_HOST }}',
              user='${{ secrets.DB_USER }}', 
              password='${{ secrets.DB_PASSWORD }}',
              database='${{ secrets.DB_NAME }}'
          )
          cursor = conn.cursor()
          
          # Stats finales
          cursor.execute('SELECT COUNT(*) FROM games')
          total_games = cursor.fetchone()[0]
          
          cursor.execute('SELECT last_page, total_games_extracted, last_extraction FROM api_state WHERE id = 1')
          result = cursor.fetchone()
          if result:
              last_page, total_extracted, last_extraction = result
              print(f'ðŸŽ® Jeux en base: {total_games}')
              print(f'ðŸ“„ DerniÃ¨re page traitÃ©e: {last_page}')
              print(f'ðŸ“Š Total extrait: {total_extracted}')
              print(f'â° DerniÃ¨re extraction: {last_extraction}')
              
              # Estimer les IDs traitÃ©s
              min_id = (last_page - 1) * 40
              max_id = last_page * 40
              print(f'ðŸ†” IDs approximatifs: {min_id}-{max_id}')
          
          conn.close()
          "
          
          echo "âœ… Extraction sÃ©quentielle automatisÃ©e terminÃ©e!"

    # Notification Discord de succÃ¨s
    - name: ðŸ“¢ Notification Discord - SuccÃ¨s
      if: success()
      run: |
        CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
        EXTRACTION_COUNT="${{ github.event.inputs.extraction_count }}"
        if [ -z "$EXTRACTION_COUNT" ]; then
          EXTRACTION_COUNT=1
        fi
        ESTIMATED_GAMES=$(($EXTRACTION_COUNT * 50))
        CURRENT_HOUR=$(date '+%H:%M %Z')
        
        # CrÃ©er le fichier JSON temporaire pour Ã©viter les problÃ¨mes d'Ã©chappement
        cat > /tmp/discord_success.json << EOF
        {
          "embeds": [{
            "title": "âœ… Extraction Automatique RÃ©ussie",
            "description": "**Extraction sÃ©quentielle terminÃ©e avec succÃ¨s**\n\nðŸ“Š **DÃ©tails:**\nâ€¢ Extractions effectuÃ©es: $EXTRACTION_COUNT\nâ€¢ Nouveaux jeux: ~$ESTIMATED_GAMES\nâ€¢ Mode: SÃ©quentiel automatisÃ©\nâ€¢ Serveur: AlwaysData",
            "color": 3066993,
            "timestamp": "$CURRENT_TIME",
            "footer": {"text": "GitHub Actions â€¢ Game Data Extractor"},
            "fields": [
              {
                "name": "ðŸŽ¯ Statut",
                "value": "Extraction rÃ©ussie",
                "inline": true
              },
              {
                "name": "ðŸ•’ Heure",
                "value": "$CURRENT_HOUR",
                "inline": true
              }
            ]
          }]
        }
        EOF
        
        # Envoyer la notification
        curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
        -H "Content-Type: application/json" \
        --data-binary @/tmp/discord_success.json

    # Notification Discord d'Ã©chec
    - name: ðŸ“¢ Notification Discord - Ã‰chec
      if: failure()
      run: |
        CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
        CURRENT_HOUR=$(date '+%H:%M %Z')
        RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        # CrÃ©er le fichier JSON pour la notification d'Ã©chec
        cat > /tmp/discord_failure.json << EOF
        {
          "embeds": [{
            "title": "âŒ Extraction Automatique Ã‰chouÃ©e",
            "description": "**Erreur lors de l'extraction sÃ©quentielle**\n\nâš ï¸ **Action requise:**\nVÃ©rifiez les logs dans GitHub Actions\n\nðŸ”— **Lien:** [Voir les dÃ©tails]($RUN_URL)",
            "color": 15158332,
            "timestamp": "$CURRENT_TIME",
            "footer": {"text": "GitHub Actions â€¢ Game Data Extractor"},
            "fields": [
              {
                "name": "ðŸŽ¯ Statut",
                "value": "Ã‰chec d'extraction",
                "inline": true
              },
              {
                "name": "ðŸ•’ Heure",
                "value": "$CURRENT_HOUR",
                "inline": true
              }
            ]
          }]
        }
        EOF
        
        # Envoyer la notification
        curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
        -H "Content-Type: application/json" \
        --data-binary @/tmp/discord_failure.json

    # Log dÃ©taillÃ© en cas d'Ã©chec
    - name: ðŸ“‹ Logs d'erreur
      if: failure()
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.AD_HOST }}
        username: ${{ secrets.AD_USER }}
        key: ${{ secrets.AD_SSH_KEY }}
        script: |
          echo "ðŸ“‹ Diagnostic en cas d'Ã©chec..."
          cd ~/game-extraction
          
          # Ã‰tat de la base de donnÃ©es
          python3 -c "
          try:
              import mysql.connector
              conn = mysql.connector.connect(
                  host='${{ secrets.DB_HOST }}',
                  user='${{ secrets.DB_USER }}', 
                  password='${{ secrets.DB_PASSWORD }}',
                  database='${{ secrets.DB_NAME }}'
              )
              print('âœ… Connexion MySQL OK')
              conn.close()
          except Exception as e:
              print(f'âŒ Erreur MySQL: {e}')
          " || echo "âŒ Impossible de se connecter Ã  MySQL"
          
          # VÃ©rification des fichiers
          echo "ðŸ“‚ Fichiers prÃ©sents:"
          ls -la scripts/ | grep -E "(run_pipeline|extraction)"
          
          # Logs rÃ©cents
          if [ -f logs/extraction.log ]; then
            echo "ðŸ“„ DerniÃ¨res lignes du log:"
            tail -20 logs/extraction.log
          else
            echo "ðŸ“„ Aucun log trouvÃ©"
          fi
