name: â° Extraction + Prix Automatique (TF-IDF Enhanced)
on:
  schedule:
    - cron: '0 */4 * * *'   # Toutes les 4 heures
  workflow_dispatch:
    inputs:
      include_prices:
        description: "Inclure le scraping des prix"
        required: false
        default: true
        type: boolean
      use_tfidf:
        description: "Utiliser le pipeline TF-IDF"
        required: false
        default: true
        type: boolean

jobs:
  complete_extraction:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸš€ Pipeline Complet sur AlwaysData
      uses: appleboy/ssh-action@v0.1.5
      with:
        host: ${{ secrets.AD_HOST }}
        username: ${{ secrets.AD_USER }}
        key: ${{ secrets.AD_SSH_KEY }}
        script: |
          cd ~/game-extraction
          
          # Variables d'environnement
          export DB_HOST="${{ secrets.DB_HOST }}"
          export DB_USER="${{ secrets.DB_USER }}"
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export DB_NAME="${{ secrets.DB_NAME }}"
          export RAWG_API_KEY="${{ secrets.RAWG_API_KEY }}"
          export DISCORD_WEBHOOK="${{ secrets.DISCORD_WEBHOOK }}"
          export LOG_LEVEL="INFO"
          export HEADLESS_MODE="true"
          export SCRAPING_ENABLED="true"
          
          USE_TFIDF="${{ github.event.inputs.use_tfidf }}"
          if [ -z "$USE_TFIDF" ]; then
            USE_TFIDF="true"
          fi
          
          echo "ðŸš€ Lancement du pipeline complet..."
          
          # Installer scikit-learn pour TF-IDF si nÃ©cessaire
          if [ "$USE_TFIDF" = "true" ]; then
            echo "ðŸ“¦ Installation scikit-learn pour TF-IDF..."
            python3 -m pip install --user scikit-learn>=1.3.0
          fi
          
          # Choisir le pipeline appropriÃ©
          if [ "$USE_TFIDF" = "true" ] && [ -f scripts/run_complete_pipeline_tfidf.py ]; then
            echo "ðŸ§  Utilisation du pipeline TF-IDF..."
            python3 scripts/run_complete_pipeline_tfidf.py
          elif [ -f scripts/run_complete_pipeline.py ]; then
            echo "ðŸ“Š Utilisation du pipeline standard..."
            python3 scripts/run_complete_pipeline.py
          else
            echo "âŒ Aucun pipeline trouvÃ©!"
            exit 1
          fi
          
          echo "ðŸ“Š Ã‰tat final de la base :"
          python3 -c "
          import mysql.connector
          try:
              conn = mysql.connector.connect(
                  host='${{ secrets.DB_HOST }}',
                  user='${{ secrets.DB_USER }}', 
                  password='${{ secrets.DB_PASSWORD }}',
                  database='${{ secrets.DB_NAME }}'
              )
              cursor = conn.cursor()
              
              cursor.execute('SELECT COUNT(*) FROM games')
              total_games = cursor.fetchone()[0]
              
              cursor.execute('SELECT COUNT(*) FROM best_price_pc')
              total_prices = cursor.fetchone()[0]
              
              cursor.execute('SELECT last_page FROM api_state WHERE id = 1')
              result = cursor.fetchone()
              last_page = result[0] if result else 0
              
              print(f'ðŸŽ® Jeux totaux: {total_games}')
              print(f'ðŸ’° Prix totaux: {total_prices}') 
              print(f'ðŸ“„ DerniÃ¨re page: {last_page}')
              
              if total_games > 0:
                  ratio = (total_prices / total_games) * 100
                  print(f'ðŸ“ˆ Couverture: {ratio:.1f}%')
              
              # Stats TF-IDF si disponibles
              cursor.execute('SHOW COLUMNS FROM best_price_pc LIKE \"similarity_score\"')
              has_similarity = cursor.fetchone() is not None
              
              if has_similarity:
                  cursor.execute('SELECT AVG(similarity_score) FROM best_price_pc WHERE similarity_score IS NOT NULL')
                  avg_sim = cursor.fetchone()[0]
                  if avg_sim:
                      print(f'ðŸ§  SimilaritÃ© TF-IDF moyenne: {float(avg_sim):.3f}')
              
              conn.close()
              
          except Exception as e:
              print(f'âŒ Erreur lors de la rÃ©cupÃ©ration des stats: {e}')
          "
    
    # Notification de succÃ¨s
    - name: ðŸ“¢ Notification Discord - SuccÃ¨s
      if: success()
      run: |
        CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
        USE_TFIDF="${{ github.event.inputs.use_tfidf }}"
        if [ -z "$USE_TFIDF" ]; then
          USE_TFIDF="true"
        fi
        
        PIPELINE_TYPE="TF-IDF Enhanced"
        if [ "$USE_TFIDF" != "true" ]; then
          PIPELINE_TYPE="Standard"
        fi
        
        cat > /tmp/discord_success.json << EOF
        {
          "embeds": [{
            "title": "âœ… Pipeline Automatique RÃ©ussi",
            "description": "**Pipeline d'extraction terminÃ© avec succÃ¨s**\n\nðŸ“Š **DÃ©tails:**\nâ€¢ Type: $PIPELINE_TYPE\nâ€¢ Mode: Extraction + Prix automatique\nâ€¢ Serveur: AlwaysData",
            "color": 3066993,
            "timestamp": "$CURRENT_TIME",
            "footer": {"text": "GitHub Actions â€¢ Game Data Extractor"}
          }]
        }
        EOF
        
        curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
        -H "Content-Type: application/json" \
        --data-binary @/tmp/discord_success.json || echo "âš ï¸ Notification Discord Ã©chouÃ©e"
    
    # Notification d'Ã©chec
    - name: ðŸ“¢ Notification Discord - Ã‰chec
      if: failure()
      run: |
        CURRENT_TIME=$(date -u +"%Y-%m-%dT%H:%M:%S.000Z")
        RUN_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
        
        cat > /tmp/discord_failure.json << EOF
        {
          "embeds": [{
            "title": "âŒ Pipeline Automatique Ã‰chouÃ©",
            "description": "**Erreur lors de l'exÃ©cution du pipeline**\n\nâš ï¸ **Action requise:**\nVÃ©rifiez les logs dans GitHub Actions\n\nðŸ”— **Lien:** [Voir les dÃ©tails]($RUN_URL)",
            "color": 15158332,
            "timestamp": "$CURRENT_TIME",
            "footer": {"text": "GitHub Actions â€¢ Game Data Extractor"}
          }]
        }
        EOF
        
        curl -X POST "${{ secrets.DISCORD_WEBHOOK }}" \
        -H "Content-Type: application/json" \
        --data-binary @/tmp/discord_failure.json || echo "âš ï¸ Notification Discord Ã©chouÃ©e"
