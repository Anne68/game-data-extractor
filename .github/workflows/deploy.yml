name: 🔎 SSH Test to AlwaysData

on:
  workflow_dispatch: {}
  push:
    branches: [ main ]

jobs:
  ssh-test:
    runs-on: ubuntu-latest
    steps:
      - name: ✅ Validate Secrets (fail if missing)
        run: |
          [ -n "${{ secrets.AD_HOST }}" ]     || { echo "❌ AD_HOST is empty"; exit 1; }
          [ -n "${{ secrets.AD_USER }}" ]     || { echo "❌ AD_USER is empty"; exit 1; }
          [ -n "${{ secrets.AD_PATH }}" ]     || { echo "❌ AD_PATH is empty"; exit 1; }
          [ -n "${{ secrets.AD_SSH_KEY }}" ]  || { echo "❌ AD_SSH_KEY is empty"; exit 1; }
          echo "✅ All secrets present"

      - name: 🔑 Test SSH connectivity
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.AD_HOST }}
          username: ${{ secrets.AD_USER }}
          key: ${{ secrets.AD_SSH_KEY }}
          port: 22
          script_stop: true
          script: |
            echo "Connected OK → host=$(hostname), user=$(whoami)"
            mkdir -p "${{ secrets.AD_PATH }}"
            echo "Deployed $(date -u)" > "${{ secrets.AD_PATH }}/_from_github.txt"
            ls -al "${{ secrets.AD_PATH }}"
