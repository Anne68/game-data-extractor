name: ðŸš€ Deploy to AlwaysData (native SSH)
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      # Validate that all required secrets exist
      - name: Validate secrets
        shell: bash
        run: |
          set -e
          [ -n "${{ secrets.AD_HOST }}" ]    || { echo "âŒ AD_HOST missing"; exit 1; }
          [ -n "${{ secrets.AD_USER }}" ]    || { echo "âŒ AD_USER missing"; exit 1; }
          [ -n "${{ secrets.AD_PATH }}" ]    || { echo "âŒ AD_PATH missing"; exit 1; }
          [ -n "${{ secrets.AD_SSH_KEY }}" ] || { echo "âŒ AD_SSH_KEY missing"; exit 1; }
          echo "âœ… All secrets are present"

      # Setup SSH key with proper permissions
      - name: Setup SSH key
        shell: bash
        env:
          SSH_KEY: ${{ secrets.AD_SSH_KEY }}
        run: |
          # Create SSH directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write the private key
          echo "$SSH_KEY" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy
          
          # Add host to known_hosts to avoid prompt
          ssh-keyscan -H ${{ secrets.AD_HOST }} >> ~/.ssh/known_hosts
          
          # Verify key format
          echo "ðŸ”‘ SSH key info:"
          head -n 1 ~/.ssh/id_deploy
          echo "..."
          tail -n 1 ~/.ssh/id_deploy

      # Test SSH connection with detailed debugging
      - name: Test SSH connectivity
        shell: bash
        run: |
          echo "ðŸ” Testing SSH connection with detailed debugging..."
          
          # Show the public key that needs to be added to AlwaysData
          echo "ðŸ”‘ PUBLIC KEY TO ADD TO ALWAYSDATA:"
          echo "================================================"
          ssh-keygen -y -f ~/.ssh/id_deploy
          echo "================================================"
          echo ""
          echo "ðŸ“‹ INSTRUCTIONS:"
          echo "1. Copy the public key above (starts with ssh-ed25519)"
          echo "2. Log into your AlwaysData admin panel"
          echo "3. Go to SSH > SSH Keys section"
          echo "4. Add the public key above"
          echo "5. Re-run this workflow after adding the key"
          echo ""
          
          # First, try a simple connection test
          echo "Step 1: Basic connection test"
          ssh -v -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
              -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes \
              ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }} \
              "echo 'Connection successful'; whoami; hostname" 2>&1 || {
              echo "âŒ SSH connection failed. This is expected if the public key isn't added to AlwaysData yet."
              echo ""
              echo "ðŸ”§ TROUBLESHOOTING:"
              echo "- Make sure you've added the PUBLIC key (shown above) to your AlwaysData SSH keys"
              echo "- Check that AD_USER (${{ secrets.AD_USER }}) is correct"
              echo "- Check that AD_HOST (${{ secrets.AD_HOST }}) is correct"
              echo ""
              
              # Check if we can reach the host
              echo "Step 2: Testing host connectivity"
              nc -zv ${{ secrets.AD_HOST }} 22 2>&1 && echo "âœ… Host is reachable on port 22" || echo "âŒ Host unreachable on port 22"
              
              exit 1
          }
          
          # If connection works, create test directory and file
          echo "âœ… SSH connection successful, setting up deployment structure..."
          ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no \
              ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }} \
              "mkdir -p '${{ secrets.AD_PATH }}' && \
               echo 'GitHub Actions deployment test at' \$(date -u) > '${{ secrets.AD_PATH }}/_github_deploy.txt' && \
               echo 'ðŸ“ Target directory created successfully'"

      # Deploy files using rsync with SSH key
      - name: Deploy with rsync
        shell: bash
        run: |
          echo "ðŸš€ Starting deployment..."
          rsync -avz --delete --progress \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'node_modules/' \
            --exclude '*.log' \
            -e "ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }}:${{ secrets.AD_PATH }}/
          echo "âœ… Deployment completed"

      # Verify deployment
      - name: Verify deployment
        shell: bash
        run: |
          echo "ðŸ” Verifying deployment..."
          ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no \
            ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }} \
            "echo 'ðŸ“‚ Contents of target directory:'; \
             ls -la '${{ secrets.AD_PATH }}' | head -20; \
             echo; \
             echo 'ðŸ“„ GitHub deployment marker:'; \
             cat '${{ secrets.AD_PATH }}/_github_deploy.txt' 2>/dev/null || echo 'Marker file not found'"

      # Cleanup
      - name: Cleanup
        shell: bash
        run: |
          rm -f ~/.ssh/id_deploy
          echo "ðŸ§¹ SSH key cleaned up"
