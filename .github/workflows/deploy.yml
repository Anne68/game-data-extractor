name: 🚀 Deploy to AlwaysData

on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: ✅ Validate Secrets
        run: |
          [ -z "${{ secrets.AD_HOST }}" ] && echo "❌ AD_HOST is empty" && exit 1 || echo "✅ AD_HOST OK"
          [ -z "${{ secrets.AD_USER }}" ] && echo "❌ AD_USER is empty" && exit 1 || echo "✅ AD_USER OK"
          [ -z "${{ secrets.AD_PATH }}" ] && echo "❌ AD_PATH is empty" && exit 1 || echo "✅ AD_PATH OK"
          [ -z "${{ secrets.AD_SSH_KEY }}" ] && echo "❌ AD_SSH_KEY is empty" && exit 1 || echo "✅ AD_SSH_KEY OK"

      - name: 🔑 Test SSH connectivity
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.AD_HOST }}
          username: ${{ secrets.AD_USER }}
          key: ${{ secrets.AD_SSH_KEY }}
          port: 22
          script: |
            echo "✅ Connected to $(hostname) as $(whoami)"

      - name: 📂 Upload files via SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.AD_HOST }}
          username: ${{ secrets.AD_USER }}
          key: ${{ secrets.AD_SSH_KEY }}
          port: 22
          source: |
            ./*
            !.git/**
            !.github/**
          target: ${{ secrets.AD_PATH }}

      - name: 🛠 Finalize on server
        uses: appleboy/ssh-action@v0.1.5
        with:
          host: ${{ secrets.AD_HOST }}
          username: ${{ secrets.AD_USER }}
          key: ${{ secrets.AD_SSH_KEY }}
          port: 22
          script_stop: true
          script: |
            set -e
            mkdir -p "${{ secrets.AD_PATH }}"
            cd "${{ secrets.AD_PATH }}"
            echo "Deployed from GitHub at $(date -u)" > _from_github.txt
            ls -al
            echo "✅ Deploy finished"
