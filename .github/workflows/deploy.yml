name: ðŸš€ Deploy to AlwaysData (native SSH)
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      # Validate that all required secrets exist
      - name: Validate secrets
        shell: bash
        run: |
          set -e
          [ -n "${{ secrets.AD_HOST }}" ]    || { echo "âŒ AD_HOST missing"; exit 1; }
          [ -n "${{ secrets.AD_USER }}" ]    || { echo "âŒ AD_USER missing"; exit 1; }
          [ -n "${{ secrets.AD_PATH }}" ]    || { echo "âŒ AD_PATH missing"; exit 1; }
          [ -n "${{ secrets.AD_SSH_KEY }}" ] || { echo "âŒ AD_SSH_KEY missing"; exit 1; }
          echo "âœ… All secrets are present"

      # Setup SSH key with proper permissions
      - name: Setup SSH key
        shell: bash
        env:
          SSH_KEY: ${{ secrets.AD_SSH_KEY }}
        run: |
          # Create SSH directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write the private key
          echo "$SSH_KEY" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy
          
          # Add host to known_hosts to avoid prompt
          ssh-keyscan -H ${{ secrets.AD_HOST }} >> ~/.ssh/known_hosts
          
          # Verify key format
          echo "ðŸ”‘ SSH key info:"
          head -n 1 ~/.ssh/id_deploy
          echo "..."
          tail -n 1 ~/.ssh/id_deploy

      # Test SSH connection
      - name: Test SSH connectivity
        shell: bash
        run: |
          echo "ðŸ” Testing SSH connection..."
          ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no \
              ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }} \
              "echo 'âœ… Connected as:' \$(whoami)@\$(hostname); \
               echo 'ðŸ“ Creating target directory...'; \
               mkdir -p '${{ secrets.AD_PATH }}'; \
               echo 'ðŸ“ Writing test file...'; \
               echo 'Deployment from GitHub Actions at' \$(date -u) > '${{ secrets.AD_PATH }}/_github_deploy.txt'"

      # Deploy files using rsync with SSH key
      - name: Deploy with rsync
        shell: bash
        run: |
          echo "ðŸš€ Starting deployment..."
          rsync -avz --delete --progress \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'node_modules/' \
            --exclude '*.log' \
            -e "ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }}:${{ secrets.AD_PATH }}/
          echo "âœ… Deployment completed"

      # Verify deployment
      - name: Verify deployment
        shell: bash
        run: |
          echo "ðŸ” Verifying deployment..."
          ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no \
            ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }} \
            "echo 'ðŸ“‚ Contents of target directory:'; \
             ls -la '${{ secrets.AD_PATH }}' | head -20; \
             echo; \
             echo 'ðŸ“„ GitHub deployment marker:'; \
             cat '${{ secrets.AD_PATH }}/_github_deploy.txt' 2>/dev/null || echo 'Marker file not found'"

      # Cleanup
      - name: Cleanup
        shell: bash
        run: |
          rm -f ~/.ssh/id_deploy
          echo "ðŸ§¹ SSH key cleaned up"
