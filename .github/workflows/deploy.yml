name: ðŸš€ Deploy to AlwaysData (native SSH)
on:
  push:
    branches: [ main ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      # Validate that all required secrets exist
      - name: Validate secrets
        shell: bash
        run: |
          set -e
          [ -n "${{ secrets.AD_HOST }}" ]    || { echo "âŒ AD_HOST missing"; exit 1; }
          [ -n "${{ secrets.AD_USER }}" ]    || { echo "âŒ AD_USER missing"; exit 1; }
          [ -n "${{ secrets.AD_PATH }}" ]    || { echo "âŒ AD_PATH missing"; exit 1; }
          [ -n "${{ secrets.AD_SSH_KEY }}" ] || { echo "âŒ ADD_SSH_KEY missing"; exit 1; }
          echo "âœ… All secrets are present"

      # Setup SSH key with proper permissions
      - name: Setup SSH key
        shell: bash
        env:
          SSH_KEY: ${{ secrets.ADD_SSH_KEY }}
        run: |
          # Create SSH directory
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # Write the private key
          echo "$SSH_KEY" > ~/.ssh/id_deploy
          chmod 600 ~/.ssh/id_deploy
          
          # Add host to known_hosts to avoid prompt
          ssh-keyscan -H ${{ secrets.AD_HOST }} >> ~/.ssh/known_hosts
          
          # Verify key format
          echo "ðŸ”‘ SSH key info:"
          head -n 1 ~/.ssh/id_deploy
          echo "..."
          tail -n 1 ~/.ssh/id_deploy

      # Test SSH connection with detailed debugging
      - name: Test SSH connectivity
        shell: bash
        run: |
          echo "ðŸ” Testing SSH connection with detailed debugging..."
          
          # First, try a simple connection test
          echo "Step 1: Basic connection test"
          ssh -v -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no -o ConnectTimeout=30 \
              -o PreferredAuthentications=publickey -o PubkeyAuthentication=yes \
              ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }} \
              "echo 'Connection successful'; whoami; hostname" 2>&1 || {
              echo "âŒ SSH connection failed. Checking common issues..."
              
              # Check if we can reach the host
              echo "Step 2: Testing host connectivity"
              nc -zv ${{ secrets.AD_HOST }} 22 2>&1 || echo "Host unreachable on port 22"
              
              # Try with password authentication to test credentials
              echo "Step 3: If you have password access, this might help debug:"
              echo "Try manually: ssh ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }}"
              
              exit 1
          }
          
          # If connection works, create test directory and file
          echo "âœ… SSH connection successful, setting up deployment structure..."
          ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no \
              ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }} \
              "mkdir -p '${{ secrets.AD_PATH }}' && \
               echo 'GitHub Actions deployment test at' \$(date -u) > '${{ secrets.AD_PATH }}/_github_deploy.txt' && \
               echo 'ðŸ“ Target directory created successfully'"

      # Deploy files using rsync with SSH key
      - name: Deploy with rsync
        shell: bash
        run: |
          echo "ðŸš€ Starting deployment..."
          rsync -avz --delete --progress \
            --exclude '.git/' \
            --exclude '.github/' \
            --exclude 'node_modules/' \
            --exclude '*.log' \
            -e "ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no" \
            ./ ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }}:${{ secrets.AD_PATH }}/
          echo "âœ… Deployment completed"

      # Verify deployment
      - name: Verify deployment
        shell: bash
        run: |
          echo "ðŸ” Verifying deployment..."
          ssh -i ~/.ssh/id_deploy -o StrictHostKeyChecking=no \
            ${{ secrets.AD_USER }}@${{ secrets.AD_HOST }} \
            "echo 'ðŸ“‚ Contents of target directory:'; \
             ls -la '${{ secrets.AD_PATH }}' | head -20; \
             echo; \
             echo 'ðŸ“„ GitHub deployment marker:'; \
             cat '${{ secrets.AD_PATH }}/_github_deploy.txt' 2>/dev/null || echo 'Marker file not found'"

      # Cleanup
      - name: Cleanup
        shell: bash
        run: |
          rm -f ~/.ssh/id_deploy
          echo "ðŸ§¹ SSH key cleaned up"
